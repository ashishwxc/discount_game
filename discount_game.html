<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
 margin:0;
 background:#0f0f0f;
 display:flex;
 justify-content:center;
 align-items:center;
 height:100vh;
 font-family:sans-serif;
 color:white;
 overflow:hidden;
}
.container{
 text-align:center;
 width:95%;
 max-width:420px;
}
#wheel{
 width:300px;
 height:300px;
 border-radius:50%;
 border:8px solid gold;
 margin:auto;
 position:relative;
 transition:transform 5s cubic-bezier(.17,.67,.83,.67);
}
.slice{
 position:absolute;
 width:50%;
 height:50%;
 background:gold;
 transform-origin:100% 100%;
}
button{
 padding:15px 25px;
 border:none;
 border-radius:10px;
 background:gold;
 font-weight:bold;
 cursor:pointer;
}
canvas{
 position:fixed;
 top:0;
 left:0;
 pointer-events:none;
}
.stamps{
 display:grid;
 grid-template-columns:repeat(5,1fr);
 gap:8px;
 margin-top:20px;
}
.stamp{
 width:45px;
 height:45px;
 border-radius:50%;
 background:#333;
}
.earned{
 background:linear-gradient(45deg,#FFD700,#FFA500);
 box-shadow:0 0 10px gold;
}
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="container">

<h2>Spin & Win</h2>
<input id="mobile" placeholder="Mobile Number"><br><br>

<div id="wheel"></div><br>

<button id="spinBtn" onclick="spin()">SPIN</button>

<h3 id="result"></h3>
<button id="waBtn" style="display:none;"
onclick="window.location.href='https://wa.me/c/918130173042'">
Order on WhatsApp
</button>

<div class="stamps" id="stamps"></div>
<p id="loyaltyText"></p>

</div>

<script>
const WEBAPP="https://script.google.com/macros/s/AKfycbwGs4aNFvnstAb2ZIv2x1wuJN-IFtLwmQ0lWUVmVSUtoGdsUMBgW973QC0UNAgQD_gV/exec";
const wheel=document.getElementById("wheel");
const slices=12;
for(let i=0;i<slices;i++){
 let div=document.createElement("div");
 div.className="slice";
 div.style.transform="rotate("+i*(360/slices)+"deg) skewY(-60deg)";
 wheel.appendChild(div);
}

// ðŸŽ¯ Probability Engine
function getPrize(){
 let rand=Math.random()*100;

 if(rand<5) return "ULTRA";
 if(rand<20) return "RARE";
 return "COMMON";
}

function spin(){
 const mobile=document.getElementById("mobile").value;
 const btn=document.getElementById("spinBtn");
 btn.disabled=true;

 const prizeType=getPrize();
 let discount;

 if(prizeType=="ULTRA"){
   discount="Buy 1 Get 1 Pasta";
 }
 else if(prizeType=="RARE"){
   discount=Math.floor(Math.random()*6)+15+"% OFF";
 }
 else{
   discount=Math.floor(Math.random()*5)+10+"% OFF";
 }

 const degree=3600+Math.floor(Math.random()*360);
 wheel.style.transform="rotate("+degree+"deg)";

 setTimeout(()=>{
   fetch(WEBAPP,{
     method:"POST",
     body:new URLSearchParams({action:"generate",mobile})
   })
   .then(res=>res.json())
   .then(data=>{
     document.getElementById("result").innerText=
       discount+"\nCode: "+data.code;

     playSound();
     startConfetti();
     document.getElementById("waBtn").style.display="block";
     loadLoyalty(mobile);
   });
 },5000);
}

// ðŸŽ‰ Confetti
const canvas=document.getElementById("confetti");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
let pieces=[];

function startConfetti(){
 for(let i=0;i<150;i++){
   pieces.push({
     x:Math.random()*canvas.width,
     y:Math.random()*canvas.height,
     r:Math.random()*6+2,
     d:Math.random()*150
   });
 }
 animate();
}

function animate(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 pieces.forEach(p=>{
   ctx.beginPath();
   ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
   ctx.fillStyle="gold";
   ctx.fill();
   p.y+=2;
   if(p.y>canvas.height) p.y=0;
 });
 requestAnimationFrame(animate);
}

// ðŸ”Š Sound
function playSound(){
 let audio=new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
 audio.play();
}

// â­ Loyalty
function loadLoyalty(mobile){
 fetch(WEBAPP,{
   method:"POST",
   body:new URLSearchParams({action:"loyalty",mobile})
 })
 .then(res=>res.text())
 .then(count=>{
   const stamps=document.getElementById("stamps");
   stamps.innerHTML="";
   for(let i=0;i<10;i++){
     let div=document.createElement("div");
     div.className="stamp";
     if(i<count%10) div.classList.add("earned");
     stamps.appendChild(div);
   }
   document.getElementById("loyaltyText").innerText=
     count%10+"/10 collected - "+(10-count%10)+" more to go";
 });
}
</script>

</body>
</html>
