<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Spin & Win</title>

<style>
body{
margin:0;
background:#0d0d0d;
color:white;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
font-family:Arial;
}

.container{
width:330px;
text-align:center;
}

input{
width:100%;
padding:12px;
border-radius:8px;
border:none;
margin-bottom:10px;
font-size:16px;
}

button{
width:100%;
padding:14px;
border-radius:10px;
border:none;
font-size:18px;
background:linear-gradient(45deg,#ffd700,#ff9800);
cursor:pointer;
}

button:disabled{
opacity:0.5;
}

canvas{display:block;margin:auto;}

.stamps{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:6px;
margin-top:12px;
}

.stamp{
height:40px;
background:#333;
border-radius:6px;
}

.filled{
background:linear-gradient(45deg,#ffd700,#fff176);
box-shadow:0 0 10px gold;
}
</style>
</head>

<body>

<div class="container">

<h3>Enter Mobile Number</h3>
<input id="mobile" type="tel" placeholder="10 digit number">

<canvas id="wheel" width="280" height="280"></canvas>

<button id="spinBtn">SPIN</button>

<h2 id="prizeText"></h2>
<h3 id="couponText"></h3>

<a id="waBtn" target="_blank" style="display:none">
<button>Order on WhatsApp</button>
</a>

<div class="stamps" id="stamps"></div>
<p id="progress"></p>

<audio id="winSound" src="win.mp3"></audio>

</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbwGs4aNFvnstAb2ZIv2x1wuJN-IFtLwmQ0lWUVmVSUtoGdsUMBgW973QC0UNAgQD_gV/exec";
const WHATSAPP_LINK="https://wa.me/c/918130173042";

/* -------- DEVICE + QR SCAN -------- */

function detectDevice(){
 if(/android/i.test(navigator.userAgent)) return "Android";
 if(/iphone|ipad|ipod/i.test(navigator.userAgent)) return "Apple";
 return "Other";
}

window.onload=function(){
 fetch(API_URL,{
  method:"POST",
  body:JSON.stringify({
   action:"scan",
   mobile:"UNKNOWN",
   device:detectDevice()
  })
 });
};

/* -------- DISCOUNTS -------- */

const COMMON=["10%","11%","12%","13%","14%","Free Iced Tea","Free Iced Americano","Free Mojito","Burger+Fries","Burger+Drink","Buy2Get1 Burger","Free Fries","Thali @129"];
const RARE=["15%","16%","17%","18%","19%","20%"];
const ULTRA=["Buy1Get1 Pasta","Buy2Get1 Bread"];

/* -------- PROBABILITY -------- */

function pickPrize(){
 let r=Math.random()*100;
 if(r<70) return COMMON[Math.floor(Math.random()*COMMON.length)];
 if(r<95) return RARE[Math.floor(Math.random()*RARE.length)];
 return ULTRA[Math.floor(Math.random()*ULTRA.length)];
}

/* -------- WHEEL -------- */

const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");

let angle=0,spinning=false;

function drawWheel(){
 const slices=14;
 const slice=2*Math.PI/slices;
 ctx.clearRect(0,0,300,300);

 for(let i=0;i<slices;i++){
  ctx.beginPath();
  ctx.fillStyle=i%2?"#ff9800":"#fbc02d";
  ctx.moveTo(140,140);
  ctx.arc(140,140,130,i*slice+angle,(i+1)*slice+angle);
  ctx.fill();
 }
}
drawWheel();

document.getElementById("spinBtn").onclick=startSpin;

function startSpin(){

 if(spinning) return;

 if(mobile.value.length<10){
  alert("Enter valid mobile");
  return;
 }

 spinning=true;
 spinBtn.disabled=true;

 let speed=0.35;

 function animate(){
  speed*=0.985;
  angle+=speed;
  drawWheel();
  if(speed>0.002){
   requestAnimationFrame(animate);
  }else finishSpin();
 }
 animate();
}

/* -------- FINISH -------- */

function finishSpin(){

 const prize=pickPrize();

 fetch(API_URL,{
  method:"POST",
  body:JSON.stringify({
   action:"spin",
   mobile:mobile.value,
   discount:prize
  })
 })
 .then(r=>r.json())
 .then(d=>{

  prizeText.innerText="ðŸŽ‰ "+prize;
  couponText.innerText=d.coupon;

  waBtn.style.display="block";
  waBtn.href=WHATSAPP_LINK;

  winSound.play();

  confetti({particleCount:200,spread:80});
  setInterval(()=>confetti({particleCount:80,spread:60}),2500);

  loadStamps();
 });
}

/* -------- STAMPS -------- */

function loadStamps(){

 fetch(API_URL,{
  method:"POST",
  body:JSON.stringify({
   action:"fetchLoyalty",
   mobile:mobile.value
  })
 })
 .then(r=>r.json())
 .then(d=>{

  stamps.innerHTML="";

  for(let i=0;i<10;i++){
   let s=document.createElement("div");
   s.className="stamp"+(i<d.stamps?" filled":"");
   stamps.appendChild(s);
  }

  progress.innerText=
   `${d.stamps}/10 collected â€” ${10-d.stamps} more orders to free dish`;
 });
}

</script>

</body>
</html>
