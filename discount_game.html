<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  margin:0;
  background:#0f0f0f;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  font-family:sans-serif;
  color:white;
}
.container{
  text-align:center;
  width:95%;
  max-width:400px;
}
input{
  padding:12px;
  width:100%;
  border-radius:8px;
  border:none;
  text-align:center;
  font-size:16px;
}
button{
  padding:14px 25px;
  border:none;
  border-radius:8px;
  background:gold;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{
  opacity:0.5;
}
#spinnerBox{
  margin-top:20px;
  font-size:60px;
  font-weight:bold;
  height:80px;
  display:none;
}
.result{
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
}
.stamps{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px;
  margin-top:20px;
}
.stamp{
  width:45px;
  height:45px;
  border-radius:50%;
  background:#333;
}
.earned{
  background:linear-gradient(45deg,#FFD700,#FFA500);
  box-shadow:0 0 12px gold;
}
canvas{
  position:fixed;
  top:0;
  left:0;
  pointer-events:none;
}
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="container">

<h2>Spin & Win</h2>

<input id="mobile" placeholder="Enter Mobile Number">

<br><br>

<button id="spinBtn" onclick="spin()">SPIN</button>

<div id="spinnerBox">0</div>

<div class="result" id="result"></div>

<button id="waBtn" style="display:none;"
onclick="window.location.href='https://wa.me/c/918130173042'">
Order on WhatsApp
</button>

<div class="stamps" id="stamps"></div>
<p id="loyaltyText"></p>

</div>

<script>
const WEBAPP="https://script.google.com/macros/s/AKfycbwGs4aNFvnstAb2ZIv2x1wuJN-IFtLwmQ0lWUVmVSUtoGdsUMBgW973QC0UNAgQD_gV/exec";

// ðŸŽ¯ Probability Logic
function getPrize(){
  let rand=Math.random()*100;

  if(rand<5){
    return {type:"ULTRA", value:"Buy 1 Get 1 Pasta"};
  }
  else if(rand<20){
    let rare=Math.floor(Math.random()*6)+15;
    return {type:"RARE", value:rare+"% OFF"};
  }
  else{
    let common=Math.floor(Math.random()*5)+10;
    return {type:"COMMON", value:common+"% OFF"};
  }
}

function spin(){
  const mobile=document.getElementById("mobile").value;
  if(!mobile) return alert("Enter mobile number");

  const btn=document.getElementById("spinBtn");
  const spinner=document.getElementById("spinnerBox");
  btn.disabled=true;
  spinner.style.display="block";

  let count=0;
  let interval=setInterval(()=>{
    spinner.innerText=Math.floor(Math.random()*50)+1;
    count++;
    if(count>25){
      clearInterval(interval);
      finishSpin(mobile);
    }
  },100);
}

function finishSpin(mobile){

  const prize=getPrize();

  fetch(WEBAPP,{
    method:"POST",
    body:new URLSearchParams({action:"generate",mobile})
  })
  .then(res=>res.json())
  .then(data=>{
    document.getElementById("result").innerText=
      prize.value+"\nCode: "+data.code;

    playSound();
    startConfetti();
    document.getElementById("waBtn").style.display="block";
    loadLoyalty(mobile);
  });
}

// ðŸŽ‰ Confetti Animation
const canvas=document.getElementById("confetti");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
let pieces=[];

function startConfetti(){
  pieces=[];
  for(let i=0;i<120;i++){
    pieces.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height,
      r:Math.random()*6+2,
      d:Math.random()*canvas.height
    });
  }
  animate();
}

function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  pieces.forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle="gold";
    ctx.fill();
    p.y+=3;
    if(p.y>canvas.height) p.y=0;
  });
  requestAnimationFrame(animate);
}

// ðŸ”Š Winning Sound
function playSound(){
  let audio=new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
  audio.play();
}

// â­ Loyalty Loader
function loadLoyalty(mobile){
 fetch(WEBAPP,{
   method:"POST",
   body:new URLSearchParams({action:"loyalty",mobile})
 })
 .then(res=>res.text())
 .then(count=>{
   const stamps=document.getElementById("stamps");
   stamps.innerHTML="";
   for(let i=0;i<10;i++){
     let div=document.createElement("div");
     div.className="stamp";
     if(i<count%10) div.classList.add("earned");
     stamps.appendChild(div);
   }
   document.getElementById("loyaltyText").innerText=
     count%10+"/10 collected - "+(10-count%10)+" more to go";
 });
}
</script>

</body>
</html>
